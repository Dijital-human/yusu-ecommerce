# CI/CD Pipeline for Yusu E-commerce / Yusu E-ticarÉ™t Ã¼Ã§Ã¼n CI/CD Pipeline
# This workflow runs tests, builds, and deploys the application
# Bu workflow testlÉ™ri iÅŸÉ™ salÄ±r, build edir vÉ™ tÉ™tbiqi deploy edir

name: CI/CD Pipeline / CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '22.x'
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

jobs:
  # Test Job / Test Ä°ÅŸi
  test:
    name: Run Tests / TestlÉ™ri Ä°ÅŸÉ™ Sal
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Run linting / Linting iÅŸÉ™ sal
        run: npm run lint

      - name: Run tests / TestlÉ™ri iÅŸÉ™ sal
        run: npm run test:ci

      - name: Upload coverage to Codecov / Coverage-u Codecov-a yÃ¼klÉ™
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Build Job / Build Ä°ÅŸi
  build:
    name: Build Application / TÉ™tbiqi Build Et
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Build application / TÉ™tbiqi build et
        run: npm run build

      - name: Upload build artifacts / Build artifact-larÄ±nÄ± yÃ¼klÉ™
        uses: actions/upload-artifact@v3
        with:
          name: build-files
          path: |
            .next/
            public/
            package.json
            package-lock.json

  # Database Migration Job / VeritabanÄ± Migration Ä°ÅŸi
  migrate:
    name: Database Migration / VeritabanÄ± Migration
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Run database migrations / VeritabanÄ± migration-larÄ±nÄ± iÅŸÉ™ sal
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # Deploy to Vercel Job / Vercel-É™ Deploy Ä°ÅŸi
  deploy:
    name: Deploy to Vercel / Vercel-É™ Deploy Et
    runs-on: ubuntu-latest
    needs: [build, migrate]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Deploy to Vercel / Vercel-É™ deploy et
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

  # Security Scan Job / TÉ™hlÃ¼kÉ™sizlik Scan Ä°ÅŸi
  security:
    name: Security Scan / TÉ™hlÃ¼kÉ™sizlik Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Run security audit / TÉ™hlÃ¼kÉ™sizlik audit-i iÅŸÉ™ sal
        run: npm audit --audit-level=moderate

      - name: Run Snyk security scan / Snyk tÉ™hlÃ¼kÉ™sizlik scan-i iÅŸÉ™ sal
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # Performance Test Job / Performans Test Ä°ÅŸi
  performance:
    name: Performance Tests / Performans TestlÉ™ri
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Build application / TÉ™tbiqi build et
        run: npm run build

      - name: Start application / TÉ™tbiqi baÅŸlat
        run: |
          npm start &
          sleep 10

      - name: Run Lighthouse CI / Lighthouse CI iÅŸÉ™ sal
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # Notification Job / BildiriÅŸ Ä°ÅŸi
  notify:
    name: Send Notifications / BildiriÅŸlÉ™r GÃ¶ndÉ™r
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()
    
    steps:
      - name: Notify on success / UÄŸurda bildir
        if: ${{ needs.deploy.result == 'success' }}
        run: |
          echo "âœ… Deployment successful! / Deploy uÄŸurlu!"
          echo "ğŸš€ Application deployed to production / TÉ™tbiq production-a deploy edildi"

      - name: Notify on failure / UÄŸursuzluqda bildir
        if: ${{ needs.deploy.result == 'failure' }}
        run: |
          echo "âŒ Deployment failed! / Deploy uÄŸursuz!"
          echo "ğŸ”§ Please check the logs / LoglarÄ± yoxlayÄ±n"
