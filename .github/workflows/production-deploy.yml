# Production Deployment Workflow / Production YÃ¼klÉ™mÉ™ Workflow-u
# This workflow handles production deployments with manual approval and rollback capability
# Bu workflow manual tÉ™sdiq vÉ™ rollback qabiliyyÉ™ti ilÉ™ production yÃ¼klÉ™mÉ™lÉ™rini idarÉ™ edir

name: Production Deployment / Production YÃ¼klÉ™mÉ™

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment / YÃ¼klÉ™mÉ™ mÃ¼hiti'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'Skip tests (not recommended) / TestlÉ™ri keÃ§ (tÃ¶vsiyÉ™ edilmir)'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    tags:
      - 'v*.*.*' # Trigger on version tags / Versiya tag-lÉ™rindÉ™ trigger et

env:
  NODE_VERSION: '22.x'
  DOMAIN: 'ulustore.com'

jobs:
  # Pre-deployment checks / YÃ¼klÉ™mÉ™ Ã¶ncÉ™si yoxlamalar
  pre-deployment:
    name: Pre-deployment Checks / YÃ¼klÉ™mÉ™ Ã–ncÉ™si Yoxlamalar
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://ulustore.com
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Run linting / Linting iÅŸÉ™ sal
        run: npm run lint
        continue-on-error: false

      - name: Run type check / Type yoxlamasÄ± iÅŸÉ™ sal
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Run tests / TestlÉ™ri iÅŸÉ™ sal
        if: ${{ !github.event.inputs.skip_tests }}
        run: npm run test:ci
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

      - name: Security audit / TÉ™hlÃ¼kÉ™sizlik audit-i
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check environment variables / MÃ¼hit dÉ™yiÅŸÉ™nlÉ™rini yoxla
        run: |
          echo "Checking required environment variables..."
          required_vars=(
            "DATABASE_URL"
            "NEXTAUTH_SECRET"
            "NEXTAUTH_URL"
          )
          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "âŒ Missing required variable: $var"
              exit 1
            fi
          done
          echo "âœ… All required environment variables are set"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

  # Build application / TÉ™tbiqi build et
  build:
    name: Build Application / TÉ™tbiqi Build Et
    runs-on: ubuntu-latest
    needs: pre-deployment
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Generate Prisma Client / Prisma Client Generate Et
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build application / TÉ™tbiqi build et
        run: npm run build
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: https://ulustore.com

      - name: Upload build artifacts / Build artifact-larÄ±nÄ± yÃ¼klÉ™
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            .next/
            public/
            package.json
            package-lock.json
          retention-days: 7

  # Database migration / VeritabanÄ± migration
  migrate:
    name: Database Migration / VeritabanÄ± Migration
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Run database migrations / VeritabanÄ± migration-larÄ±nÄ± iÅŸÉ™ sal
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Verify migration status / Migration status-unu yoxla
        run: npx prisma migrate status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # Deploy to Vercel / Vercel-É™ deploy et
  deploy:
    name: Deploy to Vercel / Vercel-É™ Deploy Et
    runs-on: ubuntu-latest
    needs: [build, migrate]
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://ulustore.com
    
    steps:
      - name: Checkout code / Kod yoxla
        uses: actions/checkout@v4

      - name: Setup Node.js / Node.js quraÅŸdÄ±r
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies / AsÄ±lÄ±lÄ±qlarÄ± quraÅŸdÄ±r
        run: npm ci

      - name: Deploy to Vercel Production / Vercel Production-a deploy et
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --yes'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Wait for deployment / YÃ¼klÉ™mÉ™ni gÃ¶zlÉ™
        run: sleep 30

      - name: Health check / SaÄŸlamlÄ±q yoxlamasÄ±
        run: |
          echo "Checking deployment health..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://ulustore.com/api/health)
          if [ "$response" -eq 200 ]; then
            echo "âœ… Deployment is healthy"
          else
            echo "âŒ Deployment health check failed (HTTP $response)"
            exit 1
          fi

  # Post-deployment verification / YÃ¼klÉ™mÉ™ sonrasÄ± yoxlama
  verify:
    name: Post-deployment Verification / YÃ¼klÉ™mÉ™ SonrasÄ± Yoxlama
    runs-on: ubuntu-latest
    needs: deploy
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Verify API endpoints / API endpoint-lÉ™rini yoxla
        run: |
          echo "Verifying API endpoints..."
          
          # Health check
          health=$(curl -s https://ulustore.com/api/health)
          if echo "$health" | grep -q "ok"; then
            echo "âœ… Health endpoint is working"
          else
            echo "âŒ Health endpoint failed"
            exit 1
          fi
          
          # Products endpoint
          products=$(curl -s -o /dev/null -w "%{http_code}" https://ulustore.com/api/v1/products)
          if [ "$products" -eq 200 ]; then
            echo "âœ… Products endpoint is working"
          else
            echo "âš ï¸ Products endpoint returned HTTP $products"
          fi

      - name: Performance check / Performans yoxlamasÄ±
        run: |
          echo "Checking page load performance..."
          # Simple performance check using curl
          load_time=$(curl -o /dev/null -s -w '%{time_total}' https://ulustore.com)
          echo "Page load time: ${load_time}s"
          if (( $(echo "$load_time > 3.0" | bc -l) )); then
            echo "âš ï¸ Page load time is slow (>3s)"
          else
            echo "âœ… Page load time is acceptable"

  # Notification / BildiriÅŸ
  notify:
    name: Send Notifications / BildiriÅŸlÉ™r GÃ¶ndÉ™r
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always()
    
    steps:
      - name: Notify on success / UÄŸurda bildir
        if: ${{ needs.deploy.result == 'success' && needs.verify.result == 'success' }}
        run: |
          echo "âœ… Production deployment successful!"
          echo "ğŸš€ Application deployed to: https://ulustore.com"
          echo "ğŸ“Š Deployment URL: ${{ needs.deploy.outputs.url }}"

      - name: Notify on failure / UÄŸursuzluqda bildir
        if: ${{ needs.deploy.result == 'failure' || needs.verify.result == 'failure' }}
        run: |
          echo "âŒ Production deployment failed!"
          echo "ğŸ”§ Please check the logs and rollback if necessary"
          exit 1

