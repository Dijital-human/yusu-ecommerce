# Logstash Pipeline Configuration / Logstash Pipeline Konfiqurasiyası
# Advanced log processing and forwarding / Ətraflı log emalı və yönləndirməsi

input {
  # File input for application logs / Tətbiq logları üçün fayl input
  file {
    path => "/usr/share/logstash/logs/*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["application"]
  }

  # Beats input for system metrics / Sistem metrikaları üçün Beats input
  beats {
    port => 5044
    tags => ["beats"]
  }

  # TCP input for custom logs / Xüsusi loglar üçün TCP input
  tcp {
    port => 5000
    codec => "json_lines"
    tags => ["custom"]
  }

  # HTTP input for webhook logs / Webhook logları üçün HTTP input
  http {
    port => 8080
    codec => "json"
    tags => ["webhook"]
  }
}

filter {
  # Parse application logs / Tətbiq loglarını parse et
  if "application" in [tags] {
    # Extract timestamp / Timestamp çıxar
    date {
      match => [ "timestamp", "ISO8601" ]
    }

    # Parse log level / Log səviyyəsini parse et
    if [level] {
      mutate {
        add_field => { "log_level" => "%{level}" }
      }
    }

    # Parse service name / Xidmət adını parse et
    if [service] {
      mutate {
        add_field => { "service_name" => "%{service}" }
      }
    }

    # Parse error details / Xəta təfərrüatlarını parse et
    if [error] {
      mutate {
        add_field => { "error_message" => "%{error}" }
      }
    }

    # Parse user information / İstifadəçi məlumatlarını parse et
    if [userId] {
      mutate {
        add_field => { "user_id" => "%{userId}" }
      }
    }

    # Parse request information / Sorğu məlumatlarını parse et
    if [request] {
      mutate {
        add_field => { "request_path" => "%{request.path}" }
        add_field => { "request_method" => "%{request.method}" }
        add_field => { "request_ip" => "%{request.ip}" }
      }
    }
  }

  # Parse system metrics / Sistem metrikalarını parse et
  if "beats" in [tags] {
    # Parse system metrics / Sistem metrikalarını parse et
    if [system] {
      mutate {
        add_field => { "cpu_usage" => "%{system.cpu.total.pct}" }
        add_field => { "memory_usage" => "%{system.memory.used.pct}" }
        add_field => { "disk_usage" => "%{system.filesystem.used.pct}" }
      }
    }

    # Parse network metrics / Şəbəkə metrikalarını parse et
    if [network] {
      mutate {
        add_field => { "network_in" => "%{network.in.bytes}" }
        add_field => { "network_out" => "%{network.out.bytes}" }
      }
    }
  }

  # Parse custom logs / Xüsusi logları parse et
  if "custom" in [tags] {
    # Parse custom application metrics / Xüsusi tətbiq metrikalarını parse et
    if [type] == "performance" {
      mutate {
        add_field => { "metric_type" => "%{type}" }
        add_field => { "metric_value" => "%{value}" }
        add_field => { "metric_unit" => "%{unit}" }
      }
    }

    # Parse security events / Təhlükəsizlik hadisələrini parse et
    if [type] == "security" {
      mutate {
        add_field => { "security_event" => "%{event}" }
        add_field => { "security_severity" => "%{severity}" }
        add_field => { "security_source" => "%{source}" }
      }
    }
  }

  # Parse webhook logs / Webhook loglarını parse et
  if "webhook" in [tags] {
    # Parse webhook events / Webhook hadisələrini parse et
    if [event] {
      mutate {
        add_field => { "webhook_event" => "%{event}" }
        add_field => { "webhook_source" => "%{source}" }
        add_field => { "webhook_target" => "%{target}" }
      }
    }
  }

  # Add common fields / Ümumi sahələr əlavə et
  mutate {
    add_field => { "environment" => "production" }
    add_field => { "cluster" => "yusu-production" }
    add_field => { "logstash_timestamp" => "%{@timestamp}" }
  }

  # Parse JSON fields / JSON sahələrini parse et
  if [message] {
    json {
      source => "message"
      target => "parsed_message"
    }
  }

  # Parse URL parameters / URL parametrlərini parse et
  if [request_path] {
    grok {
      match => { "request_path" => "%{URIPATH:path}(?:%{URIPARAM:params})?" }
    }
  }

  # Parse IP addresses / IP ünvanlarını parse et
  if [request_ip] {
    geoip {
      source => "request_ip"
      target => "geoip"
    }
  }

  # Parse user agents / İstifadəçi agentlərini parse et
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "user_agent_parsed"
    }
  }

  # Add severity levels / Səviyyə dərəcələri əlavə et
  if [log_level] {
    if [log_level] == "error" {
      mutate {
        add_field => { "severity" => "high" }
      }
    } else if [log_level] == "warn" {
      mutate {
        add_field => { "severity" => "medium" }
      }
    } else {
      mutate {
        add_field => { "severity" => "low" }
      }
    }
  }

  # Add performance indicators / Performans göstəriciləri əlavə et
  if [response_time] {
    if [response_time] > 1000 {
      mutate {
        add_field => { "performance_issue" => "slow_response" }
      }
    }
  }

  # Add security indicators / Təhlükəsizlik göstəriciləri əlavə et
  if [status_code] {
    if [status_code] >= 400 {
      mutate {
        add_field => { "security_issue" => "http_error" }
      }
    }
  }

  # Clean up fields / Sahələri təmizlə
  mutate {
    remove_field => ["host", "agent", "ecs", "input", "log"]
  }
}

output {
  # Send to Elasticsearch / Elasticsearch-ə göndər
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "yusu-logs-%{+YYYY.MM.dd}"
    template_name => "yusu-logs"
    template => "/usr/share/logstash/templates/yusu-logs.json"
    template_overwrite => true
  }

  # Send to stdout for debugging / Debug üçün stdout-a göndər
  stdout {
    codec => rubydebug
  }

  # Send alerts to email / Xəbərdarlıqları email-ə göndər
  if [severity] == "high" {
    email {
      to => "admin@yusu.com"
      subject => "High Severity Alert: %{message}"
      body => "Alert: %{message}\nTime: %{@timestamp}\nService: %{service_name}\nSeverity: %{severity}"
    }
  }

  # Send performance issues to monitoring / Performans problemlərini monitorinqə göndər
  if [performance_issue] {
    http {
      url => "http://prometheus:9090/api/v1/push"
      http_method => "post"
      format => "json"
      mapping => {
        "metric" => "yusu_performance_issue"
        "value" => "1"
        "labels" => {
          "service" => "%{service_name}"
          "issue" => "%{performance_issue}"
        }
      }
    }
  }

  # Send security issues to security monitoring / Təhlükəsizlik problemlərini təhlükəsizlik monitorinqinə göndər
  if [security_issue] {
    http {
      url => "http://security-monitor:8080/api/alerts"
      http_method => "post"
      format => "json"
      mapping => {
        "alert_type" => "security"
        "severity" => "%{severity}"
        "message" => "%{message}"
        "timestamp" => "%{@timestamp}"
        "source" => "%{service_name}"
      }
    }
  }
}
